# .github/workflows/ffuf-fuzz.yml

name: 'FFUF Fuzzing Scan'

on:
  workflow_dispatch:
    inputs:
      wordlist_file:
        description: 'The full path to the wordlist file in the repository (e.g., .github/workflows/wordlist.txt)'
        required: true
        type: string
      output_file:
        description: 'The full path and filename for the HTML output (e.g., .github/workflows/results.html)'
        required: true
        type: string

jobs:
  ffuf-fuzz:
    name: 'Run FFUF Fuzzer'
    runs-on: ubuntu-latest
    # We need write permissions to upload artifacts and read permissions to access secrets.
    permissions:
      contents: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Go Environment'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: 'Install FFUF'
        run: |
          go install -v github.com/ffuf/ffuf/v2@latest

      - name: 'Run FFUF Scan'
        id: ffuf-scan
        run: |
          # Get the inputs from the workflow dispatch form.
          WORDLIST_PATH="${{ github.event.inputs.wordlist_file }}"
          OUTPUT_PATH="${{ github.event.inputs.output_file }}"

          echo "---"
          echo "Starting FFUF scan against https://FUZZ.sbb.ch..."
          echo "Using wordlist: ${WORDLIST_PATH}"
          echo "Results will be saved to: ${OUTPUT_PATH}"
          echo "---"

          # Check if the wordlist file exists before proceeding.
          if [ ! -f "$WORDLIST_PATH" ]; then
            echo "âŒ Error: Wordlist file not found at '${WORDLIST_PATH}'"
            echo "Please check the path and ensure the file exists in your repository."
            exit 1
          fi
          
          echo "Running command: ffuf -u https://FUZZ.sbb.ch -w \"${WORDLIST_PATH}\" -o \"${OUTPUT_PATH}\" -fc 404 -fs 0 -of html -c"
          
          # Execute the FFUF command with the user-provided inputs.
          ffuf -u https://FUZZ.sbb.ch -w "${WORDLIST_PATH}" -o "${OUTPUT_PATH}" -fc 404 -fs 0 -of html -c
          
          echo "Scan complete."

      - name: 'Upload FFUF Results'
        # Uploads the output file as an artifact for easy download.
        if: always() # Run even if the scan fails.
        uses: actions/upload-artifact@v4
        with:
          name: ffuf-results
          path: ${{ github.event.inputs.output_file }}

      - name: 'Prepare Telegram Notification File'
        id: prepare-telegram
        if: always() # Run this step even if the previous one failed.
        run: |
          RESULTS_FILE="${{ github.event.inputs.output_file }}"
          MESSAGE_FILE="telegram-message.txt"

          # Create the message file with a header.
          echo "ðŸ” FFUF Fuzzing Report" > ${MESSAGE_FILE}
          echo "Target: \`https://FUZZ.sbb.ch\`" >> ${MESSAGE_FILE}
          echo "Wordlist: \`${{ github.event.inputs.wordlist_file }}\`" >> ${MESSAGE_FILE}
          echo "" >> ${MESSAGE_FILE} # Add a blank line.

          # Check if the results file has meaningful content.
          # An empty ffuf run still creates a small HTML file, so we check its size.
          # A size greater than 2KB is a good indicator of actual findings.
          if [ -s "$RESULTS_FILE" ] && [ $(stat -c%s "$RESULTS_FILE") -gt 2048 ]; then
            echo "--- Findings ---" >> ${MESSAGE_FILE}
            echo "âœ… Fuzzing completed and found potential results." >> ${MESSAGE_FILE}
            echo "Download the 'ffuf-results' artifact from the workflow run page to view the full report." >> ${MESSAGE_FILE}
          else
            echo "--- Results ---" >> ${MESSAGE_FILE}
            echo "âœ… Fuzzing complete. No results found matching the specified filters (-fc 404, -fs 0)." >> ${MESSAGE_FILE}
          fi
          
          echo "Message file created at ${MESSAGE_FILE}"

      - name: 'Send Telegram Notification with cURL'
        if: always()
        run: |
          # Read the entire message from the file, preserving newlines.
          MESSAGE=$(cat telegram-message.txt)
          
          # Send the message using curl to the Telegram Bot API.
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
