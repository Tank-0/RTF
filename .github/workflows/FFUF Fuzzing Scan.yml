name: 'FFUF Fuzzing Scan'

on:
  workflow_dispatch:
    inputs:
      wordlist_file:
        description: 'The full path to the wordlist file in the repository (e.g., .github/workflows/Best-dns-worlist/wordlist.txt)'
        required: true
        type: string
      output_file:
        description: 'The full path and filename for the HTML output (e.g., results.html)'
        required: true
        type: string

jobs:
  ffuf-fuzz:
    name: 'Run FFUF Fuzzer'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Go Environment'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: 'Install FFUF'
        run: |
          go install -v github.com/ffuf/ffuf/v2@latest

      - name: 'Run FFUF Scan with Real-time Telegram Notifications'
        id: ffuf-scan
        run: |
          WORDLIST_PATH="${{ github.event.inputs.wordlist_file }}"
          OUTPUT_PATH="${{ github.event.inputs.output_file }}"
          TELEGRAM_TOKEN="${{ secrets.TELEGRAM_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          echo "---"
          echo "Starting FFUF scan against https://FUZZ.sbb.ch..."
          echo "Using wordlist: ${WORDLIST_PATH}"
          echo "Results will be saved to: ${OUTPUT_PATH}"
          echo "Real-time findings will be sent to Telegram"
          echo "---"

          # Check if the wordlist file exists before proceeding.
          if [ ! -f "$WORDLIST_PATH" ]; then
            echo "âŒ Error: Wordlist file not found at '${WORDLIST_PATH}'"
            echo "Please check the path and ensure the file exists in your repository."
            exit 1
          fi

          # Send initial notification
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="ðŸ” *FFUF Scan Started*%0A%0ATarget: \`https://FUZZ.sbb.ch\`%0AWordlist: \`${WORDLIST_PATH}\`%0A%0Aâ³ Scanning in progress..." \
            -d parse_mode="Markdown" \
            -d disable_notification=false

          FINDING_COUNT=0

          # Run FFUF with JSONlines output for real-time parsing
          ffuf -u https://FUZZ.sbb.ch -w "${WORDLIST_PATH}" \
               -fc 404 -fs 0 -c -json 2>&1 | while IFS= read -r line; do

            # Echo the line for GitHub Actions log
            echo "$line"

            # Parse JSON findings (lines containing "input" are actual results)
            if echo "$line" | grep -q '"input"'; then
              INPUT=$(echo "$line" | grep -o '"input":"[^"]*"' | sed 's/"input":"\([^"]*\)"/\1/')
              URL=$(echo "$line" | grep -o '"url":"[^"]*"' | sed 's/"url":"\([^"]*\)"/\1/')
              STATUS=$(echo "$line" | grep -o '"status":[0-9]*' | sed 's/"status"://')
              LENGTH=$(echo "$line" | grep -o '"length":[0-9]*' | sed 's/"length"://')
              WORDS=$(echo "$line" | grep -o '"words":[0-9]*' | sed 's/"words"://')

              FINDING_COUNT=$((FINDING_COUNT + 1))

              # Build Telegram message with finding details
              MESSAGE="ðŸŽ¯ *Finding #${FINDING_COUNT}*%0A%0A"
              MESSAGE="${MESSAGE}ðŸ”¸ *Subdomain:* \`${INPUT}.sbb.ch\`%0A"
              MESSAGE="${MESSAGE}ðŸ”¸ *Status:* \`${STATUS}\`%0A"
              MESSAGE="${MESSAGE}ðŸ”¸ *Size:* \`${LENGTH}\` bytes%0A"
              MESSAGE="${MESSAGE}ðŸ”¸ *Words:* \`${WORDS}\`%0A"
              MESSAGE="${MESSAGE}ðŸ”— URL: ${URL}"

              # Send to Telegram (silent notification to avoid spam)
              curl -s -X POST \
                "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                -d chat_id="${TELEGRAM_CHAT_ID}" \
                -d text="${MESSAGE}" \
                -d parse_mode="Markdown" \
                -d disable_notification=true > /dev/null
            fi
          done

          # Generate HTML output file after scan completes
          echo "Generating HTML report..."
          ffuf -u https://FUZZ.sbb.ch -w "${WORDLIST_PATH}" \
               -o "${OUTPUT_PATH}" -fc 404 -fs 0 -of html -c

          # Send completion notification with findings count
          if [ $FINDING_COUNT -gt 0 ]; then
            COMPLETION_MSG="âœ… *FFUF Scan Completed*%0A%0A"
            COMPLETION_MSG="${COMPLETION_MSG}ðŸ“Š *Total Findings:* ${FINDING_COUNT}%0A"
            COMPLETION_MSG="${COMPLETION_MSG}ðŸŽ¯ *Target:* \`https://FUZZ.sbb.ch\`%0A%0A"
            COMPLETION_MSG="${COMPLETION_MSG}Download the 'ffuf-results' artifact from the workflow run page to view the full HTML report."
          else
            COMPLETION_MSG="âœ… *FFUF Scan Completed*%0A%0A"
            COMPLETION_MSG="${COMPLETION_MSG}ðŸ“Š *No findings* matching the filters (-fc 404, -fs 0)%0A"
            COMPLETION_MSG="${COMPLETION_MSG}ðŸŽ¯ *Target:* \`https://FUZZ.sbb.ch\`"
          fi

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${COMPLETION_MSG}" \
            -d parse_mode="Markdown" \
            -d disable_notification=false

          echo "Scan complete. Total findings: ${FINDING_COUNT}"

      - name: 'Upload FFUF Results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ffuf-results
          path: ${{ github.event.inputs.output_file }}
