# .github/workflows/nuclei-scan.yml

name: 'Nuclei Vulnerability Scan'

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'The domain to scan (e.g., example.com)'
        required: true
        type: string
      severity:
        description: 'Severity level to scan for (required)'
        required: true
        default: 'medium'
        type: choice
        options:
        - 'info'
        - 'low'
        - 'medium'
        - 'high'
        - 'critical'

jobs:
  nuclei-scan:
    name: 'Run Nuclei on Target'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Go Environment'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: 'Install Nuclei'
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

      - name: 'Update Nuclei Templates'
        run: |
          nuclei -update-templates -silent

      - name: 'Run Nuclei Scan'
        id: nuclei-scan
        run: |
          echo "Starting Nuclei scan on ${{ github.event.inputs.target_domain }}..."
          
          # Run nuclei with standard output. No -jsonl or -markdown flag.
          # The output will be clean and human-readable.
          nuclei \
            -u "${{ github.event.inputs.target_domain }}" \
            -severity "${{ github.event.inputs.severity }}" \
            -rate-limit 5 \
            -o nuclei-results.txt
          
          echo "Scan complete."

      - name: 'Prepare Telegram Notification File'
        id: prepare-telegram
        if: always() # Run this step even if the previous one failed
        run: |
          TARGET="${{ github.event.inputs.target_domain }}"
          SEVERITY="${{ github.event.inputs.severity }}"
          RESULTS_FILE="nuclei-results.txt"
          MESSAGE_FILE="telegram-message.txt"

          # Create the message file with a header
          echo "ðŸ›¡ï¸ Nuclei Scan Report" > ${MESSAGE_FILE}
          echo "Target: ${TARGET}" >> ${MESSAGE_FILE}
          echo "Severity: ${SEVERITY}" >> ${MESSAGE_FILE}
          echo "" >> ${MESSAGE_FILE} # Add a blank line

          if [ -s "$RESULTS_FILE" ]; then
            echo "--- Findings ---" >> ${MESSAGE_FILE}
            # Append the content of the results file directly
            cat "$RESULTS_FILE" >> ${MESSAGE_FILE}
          else
            echo "âœ… No vulnerabilities found." >> ${MESSAGE_FILE}
          fi
          
          echo "Message file created at ${MESSAGE_FILE}"

      - name: 'Send Telegram Notification with cURL'
        if: always()
        run: |
          # Read the entire message from the file, preserving newlines
          MESSAGE=$(cat telegram-message.txt)
          
          # Send the message using curl to the Telegram Bot API
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
