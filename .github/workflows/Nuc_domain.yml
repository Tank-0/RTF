# .github/workflows/nuclei-scan.yml

name: 'Nuclei Vulnerability Scan'

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'The domain to scan (e.g., example.com)'
        required: true
        type: string
      severity:
        description: 'Severity level to scan for (required)'
        required: true
        default: 'medium'
        type: choice
        options:
        - 'info'
        - 'low'
        - 'medium'
        - 'high'
        - 'critical'

jobs:
  nuclei-scan:
    name: 'Run Nuclei on Target'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Go Environment'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: 'Install Nuclei'
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

      - name: 'Update Nuclei Templates'
        run: |
          nuclei -update-templates -silent

      - name: 'Run Nuclei Scan'
        id: nuclei-scan
        run: |
          echo "Starting Nuclei scan on ${{ github.event.inputs.target_domain }}..."
          
          # Run nuclei and save the simple markdown output
          nuclei \
            -u "${{ github.event.inputs.target_domain }}" \
            -severity "${{ github.event.inputs.severity }}" \
            -rate-limit 5 \
            -markdown \
            -o nuclei-results.md
          
          echo "Scan complete."

      - name: 'Prepare Telegram Notification File'
        id: prepare-telegram
        if: always() # Run this step even if the previous one failed
        run: |
          TARGET="${{ github.event.inputs.target_domain }}"
          SEVERITY="${{ github.event.inputs.severity }}"
          RESULTS_FILE="nuclei-results.md"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE_FILE="telegram-message.md"

          # Create the message file
          echo "ðŸ›¡ï¸ Nuclei Scan Report" > ${MESSAGE_FILE}
          echo "Target: ${TARGET}" >> ${MESSAGE_FILE}
          echo "Severity: ${SEVERITY}" >> ${MESSAGE_FILE}
          echo "" >> ${MESSAGE_FILE} # Add a blank line

          if [ -s "$RESULTS_FILE" ]; then
            echo "--- Findings ---" >> ${MESSAGE_FILE}
            # Append the content of the results file directly
            cat "$RESULTS_FILE" >> ${MESSAGE_FILE}
          else
            echo "âœ… No vulnerabilities found." >> ${MESSAGE_FILE}
          fi
          
          # Add the link to the full report at the end
          echo "" >> ${MESSAGE_FILE} # Add a blank line
          echo "[View Full Report on GitHub](${WORKFLOW_URL})" >> ${MESSAGE_FILE}
          
          echo "Message file created at ${MESSAGE_FILE}"

      - name: 'Send Telegram Notification'
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          # This is the key change: read the message from a file
          message_file: telegram-message.md
